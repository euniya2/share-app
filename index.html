<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Deployment Console (DB Ver.)</title>
    <!-- ìŠ¤íƒ€ì¼ ê¾¸ë¯¸ê¸° (Tailwind CSS) -->
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    
    <style>
        @import url('[https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Pretendard:wght@400;600;700&display=swap](https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Pretendard:wght@400;600;700&display=swap)');
        
        body { font-family: 'Pretendard', sans-serif; }
        .code-font { font-family: 'JetBrains Mono', monospace; }
        
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 5px; }
        
        .editor-container { height: calc(100vh - 280px); min-height: 400px; }
        
        .modal-overlay {
            display: none;
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 50;
            align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }
        .modal-active { display: flex; }
    </style>
</head>
<body class="bg-[#0f1117] text-gray-300 min-h-screen flex flex-col">

    <nav class="border-b border-gray-800 bg-[#161b22] py-4 px-6 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-red-500"></div>
            <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
            <div class="w-3 h-3 rounded-full bg-green-500"></div>
            <span class="ml-4 font-bold text-white tracking-wide">WEB CONSOLE <span class="text-blue-500 text-xs ml-2 border border-blue-500 rounded px-1">DB MODE</span></span>
        </div>
        <div class="text-xs text-gray-500 code-font">v2.0.0 Firebase</div>
    </nav>

    <main class="flex-grow container mx-auto px-4 py-8 max-w-5xl">
        <header class="mb-6">
            <h1 class="text-2xl font-bold text-white mb-2">Static Web Hosting Service</h1>
            <p class="text-gray-500 text-sm">Serverless HTML deployment platform for students.</p>
        </header>

        <div class="bg-[#1e1e1e] rounded-lg shadow-2xl border border-gray-700 overflow-hidden">
            <div class="bg-[#252526] px-4 py-2 border-b border-gray-700 flex items-center justify-between">
                <span class="text-sm text-blue-400 font-medium code-font border-b-2 border-blue-400 pb-1 px-2">index.html</span>
                <div class="flex items-center">
                    <span class="text-xs font-bold text-yellow-400 flex items-center gap-1.5 bg-[#323842] px-3 py-1.5 rounded border border-yellow-500/30 shadow-sm animate-pulse">
                        Tip: Ctrl+Aë¡œ ì „ì²´ ì„ íƒ í›„ ì§€ìš°ê³  ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!
                    </span>
                </div>
            </div>
            <div class="editor-container relative group">
                <textarea id="source-code" 
                    class="w-full h-full p-4 bg-[#1e1e1e] text-[#d4d4d4] code-font text-sm focus:outline-none resize-none leading-relaxed"
                    spellcheck="false"
                    placeholder="<!-- ì—¬ê¸°ì— ì‘ì„±í•œ HTML ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” -->"></textarea>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-3 mt-6 justify-end">
            <button onclick="previewCode()" class="px-6 py-2.5 bg-[#2d333b] hover:bg-[#373e47] text-gray-300 rounded border border-gray-600 transition text-sm font-medium">Preview</button>
            <button id="generate-btn" class="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded shadow-lg transition text-sm font-bold flex items-center justify-center gap-2">Deploy (Save to DB)</button>
        </div>

        <div id="result-area" class="hidden mt-8 border-t border-gray-800 pt-8">
            <div class="bg-[#161b22] border border-gray-700 rounded-lg p-6">
                <h3 class="text-green-400 font-bold text-lg mb-2">Deploy Success</h3>
                <p class="text-sm text-gray-500 mb-4">Your page is saved on the server. Short link generated.</p>
                <div class="flex items-center gap-0 bg-[#0d1117] border border-gray-600 rounded overflow-hidden mb-4">
                    <input type="text" id="share-link" readonly class="w-full bg-transparent outline-none text-gray-400 text-sm px-4 py-3 code-font">
                    <button onclick="copyLink()" class="bg-[#21262d] hover:bg-[#30363d] text-white px-6 py-3 text-sm border-l border-gray-600 transition hover:text-blue-400 whitespace-nowrap">Copy</button>
                    <button onclick="showQRCode()" class="bg-[#21262d] hover:bg-[#30363d] text-white px-4 py-3 text-sm border-l border-gray-600 transition hover:text-green-400" title="QR Code">QR</button>
                </div>
                <div class="flex justify-between items-center">
                    <a id="preview-btn" href="#" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm underline underline-offset-4">Open in new tab -></a>
                </div>
            </div>
        </div>
    </main>
    
    <div id="qr-modal" class="modal-overlay" onclick="closeQRCode(event)">
        <div class="bg-white p-6 rounded-xl shadow-2xl text-center transform scale-100 transition-transform max-w-sm mx-4">
            <h3 class="text-gray-800 font-bold text-lg mb-4">Scan QR Code</h3>
            <div id="qrcode-container" class="bg-gray-100 p-2 rounded mb-4 flex justify-center">
                <img id="qr-image" src="" alt="Generating QR..." class="w-48 h-48 object-contain">
            </div>
            <button onclick="document.getElementById('qr-modal').classList.remove('modal-active')" class="w-full bg-gray-800 hover:bg-gray-900 text-white py-2 rounded font-medium transition">Close</button>
        </div>
    </div>

    <!-- ğŸ”¥ Firebase ì—°ë™ ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="module">
        // =========================================================================
        // [ì„¤ì • ì™„ë£Œ] ì„ ìƒë‹˜ì˜ Firebase Keyê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.
        // =========================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCn907zY1vFfAMNPxyflCOEeJSyd0yKnhs",
            authDomain: "web-class-console.firebaseapp.com",
            projectId: "web-class-console",
            storageBucket: "web-class-console.firebasestorage.app",
            messagingSenderId: "771726293778",
            appId: "1:771726293778:web:e126c7c62ee339f5dfd1cb"
        };
        // =========================================================================

        import { initializeApp } from "[https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js](https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js)";
        import { getFirestore, collection, addDoc, getDoc, doc, serverTimestamp } 
            from "[https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js](https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js)";

        // Firebase ì´ˆê¸°í™” í™•ì¸
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase Connected Successfully");
        } catch (error) { 
            console.error("Firebase Init Error:", error);
            alert("Firebase ì—°ê²° ì‹¤íŒ¨! ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }

        // ì €ì¥ í•¨ìˆ˜
        window.saveCodeToDB = async function() {
            const code = document.getElementById('source-code').value;
            if (!code.trim()) return alert("HTML ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const btn = document.getElementById('generate-btn');
            const originalText = btn.innerText;
            btn.innerText = "Saving...";
            btn.disabled = true;

            try {
                // Firestoreì˜ 'pages' ì»¬ë ‰ì…˜ì— ì €ì¥
                const docRef = await addDoc(collection(db, "pages"), {
                    code: code,
                    createdAt: serverTimestamp(),
                    type: "student-deploy"
                });

                // ì§§ì€ ë§í¬ ìƒì„± (í˜„ì¬ì£¼ì†Œ?id=ë¬¸ì„œID)
                const currentUrl = window.location.href.split('?')[0];
                const shortUrl = `${currentUrl}?id=${docRef.id}`;

                // ê²°ê³¼ í‘œì‹œ
                document.getElementById('result-area').classList.remove('hidden');
                document.getElementById('share-link').value = shortUrl;
                document.getElementById('preview-btn').href = shortUrl;
                document.getElementById('result-area').scrollIntoView({ behavior: 'smooth' });
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('generate-btn').addEventListener('click', window.saveCodeToDB);

        // í˜ì´ì§€ ë¡œë“œ ì‹œ (ë·°ì–´/ì—ë””í„° ëª¨ë“œ íŒë³„)
        window.onload = async function() {
            const params = new URLSearchParams(window.location.search);
            const docId = params.get('id');

            if (docId) {
                // ë·°ì–´ ëª¨ë“œ
                if (!db) return document.body.innerHTML = "<h1 style='color:white; padding:20px'>Error: Firebase Not Connected</h1>";
                try {
                    const docRef = doc(db, "pages", docId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        document.open(); document.write(docSnap.data().code); document.close();
                    } else {
                        document.body.innerHTML = "<h1 style='color:white; padding:20px'>404: Page Not Found</h1>";
                    }
                } catch (e) {
                    console.error("Load Error:", e);
                    document.body.innerHTML = "<h1 style='color:white; padding:20px'>Error loading page</h1>";
                }
            } else {
                // ì—ë””í„° ëª¨ë“œ (ê¸°ë³¸ ì˜ˆì œ ì½”ë“œ)
                document.getElementById('source-code').value = `<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <title>My Portfolio</title>\n    <style>\n        body { background:#111; color:#eee; font-family:sans-serif; display:flex; justify-content:center; align-items:center; height:100vh; margin:0; }\n        .card { background:#222; padding:2rem; border-radius:12px; border:1px solid #333; text-align:center; }\n        .btn { display:inline-block; margin-top:1.5rem; padding:0.8rem 1.5rem; background:#3b82f6; color:white; text-decoration:none; border-radius:6px; }\n    </style>\n</head>\n<body>\n    <div class="card">\n        <h1>Hello, World!</h1>\n        <p>This page is hosted on Firebase DB.</p>\n        <a href="#" class="btn">View Project</a>\n    </div>\n</body>\n</html>`;
            }
        };
    </script>
    
    <script>
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (ë³µì‚¬, QR ë“±)
        function copyLink() {
            document.getElementById("share-link").select();
            document.execCommand("copy");
            alert("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }
        function previewCode() {
            const newWindow = window.open();
            newWindow.document.write(document.getElementById('source-code').value);
            newWindow.document.close();
        }
        function showQRCode() {
            const link = document.getElementById('share-link').value;
            if (!link) return;
            document.getElementById('qr-image').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(link)}`;
            document.getElementById('qr-modal').classList.add('modal-active');
        }
        function closeQRCode(e) { if (e.target.id === 'qr-modal') e.target.classList.remove('modal-active'); }
    </script>
</body>
</html>
